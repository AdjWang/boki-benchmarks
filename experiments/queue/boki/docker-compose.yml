version: "3.8"
services:
  zookeeper:
    image: zookeeper:3.6.2
    hostname: zookeeper
    networks:
      - boki-net
    ports:
      - 2181:2181
    # restart: always

  zookeeper-setup:
    image: zookeeper:3.6.2
    command: /tmp/boki/zk_setup.sh
    depends_on:
       - zookeeper
    volumes:
      - /tmp/zk_setup.sh:/tmp/boki/zk_setup.sh
      - /tmp/zk_health_check:/tmp/boki/zk_health_check
    network_mode: "host"
    # restart: always
    healthcheck:
      test: ["CMD-SHELL", "/tmp/boki/zk_health_check"]
      interval: 3s
      retries: 5
      start_period: 5s
      timeout: 10s

  boki-controller:
    image: zjia/boki:sosp-ae
    networks:
      - boki-net
    entrypoint:
      - /boki/controller
      - --zookeeper_host=zookeeper:2181
      - --metalog_replicas=2
      - --userlog_replicas=1
      - --index_replicas=1
      - --v=1
    depends_on:
      zookeeper-setup:
        condition: service_healthy
    # restart: always

  boki-gateway:
    image: zjia/boki:sosp-ae
    hostname: faas-gateway
    networks:
      - boki-net
    ports:
      - 9000:9000
    entrypoint:
      - /boki/gateway
      - --tracer_exporter_endpoint=http://10.0.2.15:9411/api/v2/spans
      - --zookeeper_host=zookeeper:2181
      - --listen_iface=eth0
      - --http_port=9000
      - --func_config_file=/tmp/boki/func_config.json
      - --num_io_workers=2
      - --io_uring_entries=64
      - --io_uring_fd_slots=128
      - --lb_per_fn_round_robin
      - --max_running_requests=0
      - --v=1
    depends_on:
      zookeeper-setup:
        condition: service_healthy
    volumes:
      - /tmp/nightcore_config.json:/tmp/boki/func_config.json
    ulimits:
      memlock: -1
    # restart: always

  boki-engine-1:
    image: zjia/boki:sosp-ae
    hostname: faas-engine-1
    networks:
      - boki-net
    entrypoint:
      - /boki/engine
      - --tracer_exporter_endpoint=http://10.0.2.15:9411/api/v2/spans
      - --zookeeper_host=zookeeper:2181
      - --listen_iface=eth0
      - --root_path_for_ipc=/tmp/boki/ipc
      - --func_config_file=/tmp/boki/func_config.json
      - --num_io_workers=4
      - --instant_rps_p_norm=0.8
      - --io_uring_entries=64
      - --io_uring_fd_slots=128
      - --enable_shared_log
      - --slog_engine_enable_cache
      - --slog_engine_cache_cap_mb=512
      - --slog_engine_propagate_auxdata
      - --v=1
    depends_on:
      zookeeper-setup:
        condition: service_healthy
    volumes:
      - /mnt/inmem1/boki:/tmp/boki
      - /mnt/inmem1/gperf:/tmp/gperf
      - /sys/fs/cgroup:/tmp/root_cgroupfs
    environment:
      
      - FAAS_NODE_ID=1
      - FAAS_CGROUP_FS_ROOT=/tmp/root_cgroupfs
    ulimits:
      memlock: -1
    # restart: always

  boki-storage-1:
    image: zjia/boki:sosp-ae
    hostname: faas-storage-1
    networks:
      - boki-net
    entrypoint:
      - /boki/storage
      - --tracer_exporter_endpoint=http://10.0.2.15:9411/api/v2/spans
      - --zookeeper_host=zookeeper:2181
      - --listen_iface=eth0
      - --db_path=/tmp/storage/logdata
      - --num_io_workers=2
      - --io_uring_entries=64
      - --io_uring_fd_slots=128
      - --slog_local_cut_interval_us=300
      - --slog_storage_bgthread_interval_ms=1
      - --slog_storage_backend=rocksdb
      - --slog_storage_cache_cap_mb=512
      - --v=1
    depends_on:
      zookeeper-setup:
        condition: service_healthy
    volumes:
      - /mnt/storage1:/tmp/storage
      - /mnt/storage1/gperf:/tmp/gperf
    environment:
      
      - FAAS_NODE_ID=1
    ulimits:
      memlock: -1
    # restart: always

  boki-sequencer-1:
    image: zjia/boki:sosp-ae
    hostname: faas-sequencer-1
    networks:
      - boki-net
    entrypoint:
      - /boki/sequencer
      - --tracer_exporter_endpoint=http://10.0.2.15:9411/api/v2/spans
      - --zookeeper_host=zookeeper:2181
      - --listen_iface=eth0
      - --num_io_workers=2
      - --io_uring_entries=64
      - --io_uring_fd_slots=128
      - --slog_global_cut_interval_us=300
      - --v=1
    depends_on:
      zookeeper-setup:
        condition: service_healthy
    volumes:
      - /mnt/sequencer1/gperf:/tmp/gperf
    environment:
      
      - FAAS_NODE_ID=1
    ulimits:
      memlock: -1
    # restart: always

  boki-sequencer-2:
    image: zjia/boki:sosp-ae
    hostname: faas-sequencer-2
    networks:
      - boki-net
    entrypoint:
      - /boki/sequencer
      - --tracer_exporter_endpoint=http://10.0.2.15:9411/api/v2/spans
      - --zookeeper_host=zookeeper:2181
      - --listen_iface=eth0
      - --num_io_workers=2
      - --io_uring_entries=64
      - --io_uring_fd_slots=128
      - --slog_global_cut_interval_us=300
      - --v=1
    depends_on:
      zookeeper-setup:
        condition: service_healthy
    volumes:
      - /mnt/sequencer2/gperf:/tmp/gperf
    environment:
      
      - FAAS_NODE_ID=2
    ulimits:
      memlock: -1
    # restart: always

  consumer-fn-1:
    image: zjia/boki-queuebench:sosp-ae
    networks:
      - boki-net
    entrypoint: ["/tmp/boki/run_launcher", "/queuebench-bin/main", "2"]
    volumes:
      - /mnt/inmem1/boki:/tmp/boki
    environment:
      - FAAS_GO_MAX_PROC_FACTOR=2
      - GOGC=200
    depends_on:
      - boki-engine-1
    # restart: always

  producer-fn-1:
    image: zjia/boki-queuebench:sosp-ae
    networks:
      - boki-net
    entrypoint: ["/tmp/boki/run_launcher", "/queuebench-bin/main", "1"]
    volumes:
      - /mnt/inmem1/boki:/tmp/boki
    environment:
      - FAAS_GO_MAX_PROC_FACTOR=2
      - GOGC=200
    depends_on:
      - boki-engine-1
    # restart: always

  goexample-fn-1:
    image: zjia/boki-goexample:sosp-ae
    networks:
      - boki-net
    entrypoint: ["/tmp/boki/run_launcher", "/goexample-bin/main", "3"]
    volumes:
      - /mnt/inmem1/boki:/tmp/boki
    environment:
      - FAAS_GO_MAX_PROC_FACTOR=2
      - GOGC=200
    depends_on:
      - boki-engine-1
    # restart: always

networks:
  boki-net:
    driver: bridge

